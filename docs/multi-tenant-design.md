# マルチテナント対応設計書：フランチャイズ全体タスク管理

## 概要

ARUフランチャイズ全体の就労継続支援B型開業プロジェクトを一元管理するシステム設計。

**目的**:
- 開業タスクテンプレートの標準化
- 新規顧客登録時の自動タスク生成
- 全顧客横断的な進捗管理・アラート

---

## 1. テーブル設計

### 1.1 顧客マスタ（新規）

フランチャイズ先の管理テーブル。

| フィールド名 | 型 | 説明 | 例 |
|-------------|-----|------|-----|
| 顧客ID | オートナンバー | 一意識別子 | 1 |
| 会社名 | テキスト | 法人名 | 合同会社LIVENOW |
| 代表者名 | テキスト | 代表者 | 柴田様 |
| 担当コンサル | 単一選択 | ARU担当者 | 金沢 |
| 対象エリア | テキスト | 開業予定地域 | 東京都大田区 |
| 開業予定日 | 日付 | 目標開業日 | 2026/02/01 |
| 契約開始日 | 日付 | コンサル契約日 | 2025/10/01 |
| ステータス | 単一選択 | 準備中/進行中/開業済/解約 | 進行中 |
| 全タスク数 | 数式 | COUNT(タスク) | 52 |
| 完了タスク数 | 数式 | COUNTIF(タスク.ステータス="完了") | 10 |
| 進捗率 | 数式 | 完了タスク数/全タスク数 | 19.2% |
| 遅延タスク数 | 数式 | 期限超過タスクのカウント | 3 |
| 連絡先メール | メール | 通知送信先 | - |
| 連絡先電話 | 電話番号 | 緊急連絡先 | - |
| 備考 | 長文テキスト | メモ | - |
| 作成日 | 日付（自動） | レコード作成日 | - |
| 更新日 | 日付（自動） | 最終更新日 | - |

**ステータス選択肢**:
- 準備中（グレー）- 契約前/準備段階
- 進行中（青）- 開業準備進行中
- 開業済（緑）- 開業完了
- 保留（黄）- 一時停止
- 解約（赤）- 契約解除

---

### 1.2 タスクテンプレート（新規）

開業タスクの標準テンプレート。新規顧客登録時にこれを元にタスクを自動生成。

| フィールド名 | 型 | 説明 | 例 |
|-------------|-----|------|-----|
| テンプレートID | オートナンバー | 一意識別子 | 1 |
| WBS番号 | テキスト | タスク番号 | 1.1 |
| タスク名 | テキスト | タスクタイトル | 定款文言提供 |
| カテゴリ | 単一選択 | WBS大分類 | 法人関連 |
| 担当区分 | 単一選択 | ARU/顧客 | ARU |
| 標準所要日数 | 数値 | 予定期間（日） | 36 |
| 開業日からのオフセット | 数値 | 開業日から何日前に期限か（負の値） | -90 |
| 開始オフセット | 数値 | 開業日から何日前に開始か（負の値） | -126 |
| 表示順 | 数値 | ソート用 | 1 |
| 備考テンプレート | 長文テキスト | デフォルトの備考 | - |
| 必須フラグ | チェックボックス | 必須タスクか | true |

**カテゴリ選択肢**:
1. 法人関連
2. 融資
3. 物件
4. 採用
5. 指定申請
6. 利用者獲得
7. 業務獲得
8. その他運営関連

---

### 1.3 タスク（既存拡張）

実際のタスク管理テーブル。顧客ごとにテンプレートから生成される。

| フィールド名 | 型 | 説明 | 例 |
|-------------|-----|------|-----|
| タスクID | オートナンバー | 一意識別子 | 1 |
| **顧客** | リンク | 顧客マスタへのリンク | 合同会社LIVENOW |
| **テンプレート** | リンク | タスクテンプレートへのリンク | 定款文言提供 |
| WBS番号 | テキスト | タスク番号 | 1.1 |
| タスク名 | テキスト | タスクタイトル | 定款文言提供 |
| カテゴリ | 単一選択 | WBS大分類 | 法人関連 |
| 担当区分 | 単一選択 | ARU/顧客 | ARU |
| 担当者 | ユーザー | 具体的な担当者 | @金沢 |
| 開始日 | 日付 | 予定開始日 | 2025/10/01 |
| 期限 | 日付 | 予定終了日 | 2025/11/06 |
| 期間（日） | 数式 | 期限-開始日 | 36 |
| ステータス | 単一選択 | タスク状態 | 進行中 |
| 完了率 | 数値（%） | 0-100 | 50 |
| **期限超過** | 数式 | TODAY() > 期限 AND ステータス != "完了" | true/false |
| **残日数** | 数式 | 期限 - TODAY() | -3 |
| **緊急度** | 数式 | 残日数による自動判定 | 超過/緊急/注意/通常 |
| 備考 | 長文テキスト | 進捗・メモ | - |
| 作成日 | 日付（自動） | - | - |
| 更新日 | 日付（自動） | - | - |

**ステータス選択肢**:
- 未着手（グレー）
- 進行中（青）
- 完了（緑）
- 保留（黄）
- ブロック中（赤）

**緊急度の計算ロジック**:
```
IF(ステータス = "完了", "完了",
  IF(残日数 < 0, "超過",
    IF(残日数 <= 3, "緊急",
      IF(残日数 <= 7, "注意", "通常"))))
```

---

## 2. タスクテンプレート初期データ

就労継続支援B型開業に必要なタスクフルセット（52タスク）。

### 2.1 法人関連（3タスク）

| WBS | タスク名 | 担当 | 所要日数 | 開業オフセット |
|-----|---------|------|---------|--------------|
| 1.1 | 定款文言提供 | ARU | 36 | -90 |
| 1.2 | 定款作成（変更） | 顧客 | 36 | -90 |
| 1.3 | 登記簿登録 | 顧客 | 14 | -60 |

### 2.2 融資（5タスク）

| WBS | タスク名 | 担当 | 所要日数 | 開業オフセット |
|-----|---------|------|---------|--------------|
| 2.1 | 融資先検討 | 顧客 | 30 | -150 |
| 2.2 | 事業計画書作成 | ARU | 30 | -120 |
| 2.3 | 各種見積もり作成 | 顧客 | 14 | -100 |
| 2.4 | 融資面談 | 顧客 | 7 | -90 |
| 2.5 | 融資実行 | 顧客 | 30 | -60 |

### 2.3 物件（10タスク）

| WBS | タスク名 | 担当 | 所要日数 | 開業オフセット |
|-----|---------|------|---------|--------------|
| 3.1 | エリア決定 | 顧客 | 26 | -150 |
| 3.2 | 物件リスト作成 | ARU | 9 | -120 |
| 3.3 | 内見及び物件検討 | 顧客 | 30 | -90 |
| 3.4 | レイアウト図作成 | ARU | 29 | -60 |
| 3.5 | 消防確認 | ARU | 29 | -60 |
| 3.6 | 建築確認 | ARU | 29 | -60 |
| 3.7 | 都市計画確認 | ARU | 29 | -60 |
| 3.8 | まちづくり条例確認 | ARU | 29 | -60 |
| 3.9 | 物件決定（契約） | 顧客 | 30 | -30 |
| 3.10 | 保険内容決定 | 顧客 | 30 | -30 |

### 2.4 採用（5タスク）

| WBS | タスク名 | 担当 | 所要日数 | 開業オフセット |
|-----|---------|------|---------|--------------|
| 4.1 | ジョブメドレー、リタリコ、ウェルミージョブ連絡 | ARU | 9 | -120 |
| 4.2 | ジョブメドレー、リタリコ、ウェルミージョブ契約 | 顧客 | 9 | -120 |
| 4.3 | ハローワーク、Indeed掲載 | 顧客 | 7 | -100 |
| 4.4 | サービス管理責任者決定 | 顧客 | 29 | -60 |
| 4.5 | その他職員決定 | 顧客 | 60 | 0 |

### 2.5 指定申請（11タスク）

| WBS | タスク名 | 担当 | 所要日数 | 開業オフセット |
|-----|---------|------|---------|--------------|
| 5.1 | 都道府県及び市町村へフロー確認 | ARU | 9 | -120 |
| 5.2 | 在宅就労申請フロー確認 | ARU | 9 | -120 |
| 5.3 | 屋号・作業内容・事業所方針検討 | ARU | 30 | -75 |
| 5.4 | 事前協議書作成 | ARU | 14 | -60 |
| 5.5 | 市町村と事前協議 | 顧客 | 18 | -40 |
| 5.6 | 協力医療機関確保 | 顧客 | 35 | -40 |
| 5.7 | 指定申請書類作成 | ARU | 9 | -60 |
| 5.8 | 指定申請書類確認 | 顧客 | 18 | -40 |
| 5.9 | 指定申請書類提出 | 顧客 | 11 | -30 |
| 5.10 | 最終版指定申請書類共有 | 顧客 | 15 | -15 |
| 5.11 | 現地確認 | 顧客 | 30 | 0 |

### 2.6 利用者獲得（9タスク）

| WBS | タスク名 | 担当 | 所要日数 | 開業オフセット |
|-----|---------|------|---------|--------------|
| 6.1 | チラシ・三つ折りパンフレット作成 | ARU | 16 | -30 |
| 6.2 | ポスティング会社リストアップ | ARU | 18 | -40 |
| 6.3 | 公営住宅等配布先リストアップ | ARU | 18 | -40 |
| 6.4 | 配布エリア提案、ポスト方法レクチャー | ARU | 12 | -30 |
| 6.5 | ポスティング会社依頼（自社配布も可） | 顧客 | 12 | -30 |
| 6.6 | 印刷業者へ依頼、印刷 | 顧客 | 5 | -30 |
| 6.7 | 相談支援事業所等営業先リストアップ | ARU | 18 | -40 |
| 6.8 | 相談支援事業所等営業レクチャー | ARU | 12 | -30 |
| 6.9 | 相談支援事業所等営業 | 顧客 | 30 | 0 |

### 2.7 業務獲得（4タスク）

| WBS | タスク名 | 担当 | 所要日数 | 開業オフセット |
|-----|---------|------|---------|--------------|
| 7.1 | PC作業トライアル(職員向け) | 顧客 | 30 | 0 |
| 7.2 | 業務受託先リストアップ | ARU | 18 | -40 |
| 7.3 | 業務受託先営業レクチャー（テレアポ） | ARU | 12 | -30 |
| 7.4 | 業務受託先営業 | 顧客 | 30 | 0 |

### 2.8 その他運営関連（5タスク）

| WBS | タスク名 | 担当 | 所要日数 | 開業オフセット |
|-----|---------|------|---------|--------------|
| 8.1 | 利用者獲得、業務獲得 | ARU | 30 | -30 |
| 8.2 | 人員配置、職員の職務内容 | ARU | 30 | 0 |
| 8.3 | 運営マニュアル説明 | ARU | 30 | 0 |
| 8.4 | 法定研修 | ARU | 15 | 0 |
| 8.5 | 営業進捗共有／確認 | 顧客 | 15 | 0 |

---

## 3. Larkオートメーション設計

### 3.1 自動タスク生成（顧客登録時）

**トリガー**: 顧客マスタに新規レコード追加

**条件**: ステータス = "進行中"

**アクション**:
1. タスクテンプレートの全レコードを取得
2. 各テンプレートに対して:
   - 新規タスクレコードを作成
   - 顧客リンクを設定
   - テンプレートリンクを設定
   - 開業予定日から期限を計算: `開業予定日 + 開業オフセット`
   - 開始日を計算: `期限 - 所要日数`
   - ステータス = "未着手"
3. タスクテーブルに一括挿入

**実装方法**: Lark Base Automation または APIスクリプト

```javascript
// 期限計算ロジック
const 開業予定日 = new Date(顧客.開業予定日);
const 期限 = new Date(開業予定日);
期限.setDate(期限.getDate() + テンプレート.開業オフセット);
const 開始日 = new Date(期限);
開始日.setDate(開始日.getDate() - テンプレート.所要日数);
```

---

### 3.2 期限超過アラート

**トリガー**: 毎日 9:00 AM（定時実行）

**条件**:
- ステータス != "完了" AND ステータス != "保留"
- 期限 < TODAY()

**アクション**:
1. 期限超過タスクを抽出
2. 顧客別にグループ化
3. 顧客担当コンサルへLark通知
4. 顧客へメール通知（オプション）

**通知内容**:
```
【期限超過アラート】
顧客: {会社名}
超過タスク数: {件数}

{タスク一覧}
- {WBS} {タスク名} (期限: {期限}, {残日数}日超過)
```

---

### 3.3 進捗遅延警告

**トリガー**: 毎日 9:00 AM（定時実行）

**条件**:
- ステータス = "未着手"
- 残日数 <= 3（期限3日前で未着手）

**アクション**:
1. 該当タスクを抽出
2. 顧客担当コンサルへ警告通知

**通知内容**:
```
【進捗遅延警告】
以下のタスクが期限間近ですが未着手です。

顧客: {会社名}
- {WBS} {タスク名} (期限: {期限}, 残り{残日数}日)
```

---

### 3.4 週次進捗レポート

**トリガー**: 毎週月曜 9:00 AM

**アクション**:
1. 全顧客の進捗を集計
2. 進捗率が低い順にソート
3. Larkグループへレポート投稿

**レポート内容**:
```
【週次進捗レポート】{日付}

■ 全体サマリ
- アクティブ顧客数: {件数}
- 全タスク完了率: {平均%}
- 期限超過タスク: {件数}

■ 顧客別進捗（進捗率低い順）
1. {会社名}: {進捗率}% (超過:{件数}, 残:{件数})
2. {会社名}: {進捗率}% (超過:{件数}, 残:{件数})
...

■ 今週期限のタスク
- {顧客} / {タスク名} (期限: {期限})
...
```

---

## 4. ダッシュボード設計

### 4.1 全体ダッシュボード

**ビュー構成**:

1. **KPIカード（上部）**
   - アクティブ顧客数
   - 全体進捗率
   - 期限超過タスク数
   - 今週完了タスク数

2. **顧客進捗一覧（テーブル）**
   - 顧客名 | 開業予定日 | 進捗率 | 超過数 | ステータス
   - 進捗率の低い順でソート
   - 条件付き書式: 超過あり=赤, 進捗遅れ=黄

3. **期限超過タスク一覧（テーブル）**
   - 顧客名 | WBS | タスク名 | 期限 | 超過日数
   - 超過日数の多い順でソート

4. **今週期限タスク（カレンダー）**
   - 今週期限のタスクをカレンダー表示

---

### 4.2 顧客別ダッシュボード

**フィルタ**: 顧客を選択

**ビュー構成**:

1. **顧客情報カード**
   - 会社名, 開業予定日, 担当コンサル
   - 進捗率プログレスバー

2. **ガントチャート**
   - カテゴリごとにグループ化
   - 期限超過タスクは赤表示

3. **カンバンボード**
   - 未着手 | 進行中 | 完了 | ブロック中
   - ドラッグ&ドロップでステータス変更

4. **カテゴリ別進捗**
   - 法人関連: 100%
   - 融資: 0%
   - 物件: 50%
   - ...

---

## 5. 実装ロードマップ

### Phase 1: 基盤構築（最優先）
- [ ] 顧客マスタテーブル作成
- [ ] タスクテンプレートテーブル作成
- [ ] タスクテンプレート52件の初期データ投入
- [ ] 既存タスクテーブルへの顧客リンク追加

### Phase 2: 自動化
- [ ] 新規顧客登録時の自動タスク生成（APIスクリプト）
- [ ] 期限超過アラート設定
- [ ] 進捗遅延警告設定

### Phase 3: ダッシュボード
- [ ] 全体ダッシュボードビュー作成
- [ ] 顧客別ダッシュボードビュー作成
- [ ] KPIカード設定

### Phase 4: レポート
- [ ] 週次進捗レポート自動送信
- [ ] 顧客向け進捗レポート（オプション）

---

## 6. テーブル間リレーション図

```
顧客マスタ
    │
    ├─── タスク (1:N)
    │        │
    │        └─── タスクテンプレート (N:1)
    │
    ├─── 物件 (1:N)
    │        │
    │        └─── 不動産会社 (N:1)
    │
    ├─── 面接者 (1:N)
    │
    ├─── 申請書類 (1:N)
    │
    ├─── 提供書類 (1:N)
    │
    └─── 議事録 (1:N)

タスクテンプレート（独立マスタ）
```

---

*設計書作成日: 2026/01/18*
*対象Issue: #3 マルチテナント対応：フランチャイズ全体のタスク管理基盤構築*
